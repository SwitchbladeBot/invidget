name: CI

on: [push, pull_request_target]

env:
  DOCKER_REGISTRY: switchbladebot/invidget
  NODE_VERSION: 18.x

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Standard
        run: npx standard
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
    matrix:
      node-version: [14.x, 16.x, 18.x]
      steps:
        - name: Checkout
          uses: actions/checkout@v3
        - name: Setup Node
          uses: actions/setup-node@v3
          with:
            node-version: ${{ matrix.node-version }}
        - name: Install Dependencies
          run: npm install
        - name: Run Tests
          run: npm test
          env:
            CI: true

  build:
    name: Docker
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.event_name == 'push'
    strategy:
      matrix:
        node-version: [latest, ${{ github.ref }}]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Build and publish to registry
        uses: docker/build-push-action@master
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          repository: ${{ env.DOCKER_REGISTRY }}
          tag_with_ref: ${{ matrix.tag }}
